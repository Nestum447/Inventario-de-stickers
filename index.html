<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>OCR Inventario PRO</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body{font-family:Arial;background:#f3f4f6;padding:14px}
h2{text-align:center}
button{width:100%;padding:12px;margin:6px 0;font-size:16px;border:none;border-radius:6px}
.primary{background:#2563eb;color:white}
.secondary{background:#16a34a;color:white}
.export{background:#111827;color:white}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #ccc;padding:6px;font-size:13px}
th{background:#e5e7eb}
#status{text-align:center;font-size:14px;margin:8px}

td.editing{
  outline:2px solid #2563eb;
  background:#eef2ff;
}

canvas{
  width:100%;
  border:2px dashed #999;
  margin-top:10px;
  touch-action:none;
}
</style>
</head>

<body>

<h2>üì¶ OCR Inventario PRO</h2>

<button class="primary" onclick="camara.click()">üì∑ Tomar foto</button>
<button class="secondary" onclick="galeria.click()">üñºÔ∏è Cargar imagen</button>

<input id="camara" type="file" accept="image/*" capture="environment" hidden onchange="cargarImagen(this)">
<input id="galeria" type="file" accept="image/*" hidden onchange="cargarImagen(this)">

<div id="status">Dibuja, mueve o ajusta el cuadro</div>

<canvas id="canvas"></canvas>

<button class="export" onclick="procesarOCR()">üîç Extraer texto</button>
<button class="export" onclick="exportarExcel()">‚¨áÔ∏è Descargar Excel</button>

<table id="tabla">
<thead>
<tr>
<th>#</th>
<th>Descripci√≥n</th>
</tr>
</thead>
<tbody></tbody>
</table>

<script>
let canvas=document.getElementById("canvas");
let ctx=canvas.getContext("2d");
let img=new Image();

let x1=0,y1=0,x2=0,y2=0;
let mode=null;
let contador=1;
const HANDLE=12;

/* ======================
   CARGAR IMAGEN
====================== */
function cargarImagen(input){
  const file=input.files[0];
  if(!file) return;

  const reader=new FileReader();
  reader.onload=e=>{
    img.onload=()=>{
      const max=1200;
      const s=Math.min(max/img.width,max/img.height,1);
      canvas.width=img.width*s;
      canvas.height=img.height*s;
      draw();
    };
    img.src=e.target.result;
  };
  reader.readAsDataURL(file);
}

/* ======================
   DIBUJO
====================== */
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(img,0,0,canvas.width,canvas.height);
  if(x2){
    ctx.strokeStyle="red";
    ctx.lineWidth=2;
    ctx.strokeRect(x1,y1,x2-x1,y2-y1);
    drawHandles();
  }
}

function drawHandles(){
  ctx.fillStyle="red";
  [[x1,y1],[x2,y1],[x1,y2],[x2,y2]].forEach(p=>{
    ctx.beginPath();
    ctx.arc(p[0],p[1],HANDLE/2,0,Math.PI*2);
    ctx.fill();
  });
}

/* ======================
   POSICI√ìN REAL
====================== */
function getPos(e){
  const r=canvas.getBoundingClientRect();
  const sx=canvas.width/r.width;
  const sy=canvas.height/r.height;
  return {
    x:(e.clientX-r.left)*sx,
    y:(e.clientY-r.top)*sy
  };
}

function hitHandle(px,py,hx,hy){
  return Math.abs(px-hx)<HANDLE && Math.abs(py-hy)<HANDLE;
}

/* ======================
   INTERACCI√ìN CANVAS
====================== */
canvas.addEventListener("pointerdown",e=>{
  const p=getPos(e);
  if(hitHandle(p.x,p.y,x1,y1)) mode="resize-tl";
  else if(hitHandle(p.x,p.y,x2,y1)) mode="resize-tr";
  else if(hitHandle(p.x,p.y,x1,y2)) mode="resize-bl";
  else if(hitHandle(p.x,p.y,x2,y2)) mode="resize-br";
  else if(p.x>x1 && p.x<x2 && p.y>y1 && p.y<y2) mode="move";
  else{ mode="draw"; x1=p.x; y1=p.y; x2=p.x; y2=p.y; }
});

canvas.addEventListener("pointermove",e=>{
  if(!mode) return;
  const p=getPos(e);

  if(mode==="draw"){ x2=p.x; y2=p.y; }
  if(mode==="move"){
    const w=x2-x1,h=y2-y1;
    x1=p.x-w/2; y1=p.y-h/2;
    x2=x1+w; y2=y1+h;
  }
  if(mode==="resize-tl"){ x1=p.x; y1=p.y; }
  if(mode==="resize-tr"){ x2=p.x; y1=p.y; }
  if(mode==="resize-bl"){ x1=p.x; y2=p.y; }
  if(mode==="resize-br"){ x2=p.x; y2=p.y; }

  draw();
});
canvas.addEventListener("pointerup",()=>mode=null);

/* ======================
   OCR
====================== */
async function procesarOCR(){
  if(!x2) return alert("Selecciona un √°rea");

  status.innerText="OCR r√°pido‚Ä¶";

  const x=Math.min(x1,x2);
  const y=Math.min(y1,y2);
  const w=Math.abs(x2-x1);
  const h=Math.abs(y2-y1);

  const cut=document.createElement("canvas");
  cut.width=w; cut.height=h;
  cut.getContext("2d").drawImage(canvas,x,y,w,h,0,0,w,h);

  const {data:{text}}=await Tesseract.recognize(
    cut,"spa+eng",
    {tessedit_pageseg_mode:Tesseract.PSM.SINGLE_LINE}
  );

  const limpio=text.replace(/\s+/g," ").trim();
  if(limpio) agregarFila(limpio);

  status.innerText="‚úÖ Texto extra√≠do";
}

/* ======================
   TABLA EDITABLE
====================== */
function agregarFila(texto){
  const tr=tabla.querySelector("tbody").insertRow();
  tr.insertCell(0).innerText=contador++;
  const td=tr.insertCell(1);
  td.innerText=texto;

  td.addEventListener("dblclick",()=>editarCelda(td));
}

function editarCelda(td){
  if(td.isContentEditable) return;
  td.contentEditable=true;
  td.classList.add("editing");
  td.focus();

  td.addEventListener("blur",()=>cerrarEdicion(td),{once:true});
  td.addEventListener("keydown",e=>{
    if(e.key==="Enter"){
      e.preventDefault();
      td.blur();
    }
  });
}

function cerrarEdicion(td){
  td.contentEditable=false;
  td.classList.remove("editing");
}

/* ======================
   EXCEL
====================== */
function exportarExcel(){
  const filas=[["#","Descripci√≥n"]];
  document.querySelectorAll("#tabla tbody tr").forEach(tr=>{
    filas.push([...tr.cells].map(td=>td.innerText));
  });

  const hoja=XLSX.utils.aoa_to_sheet(filas);
  const libro=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(libro,hoja,"Inventario");
  XLSX.writeFile(libro,"inventario_pro.xlsx");
}
</script>

</body>
</html>
