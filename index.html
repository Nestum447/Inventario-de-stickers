<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>OCR Inventario Selecci√≥n Manual</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body{font-family:Arial;background:#f3f4f6;padding:12px}
h2{text-align:center}
button{width:100%;padding:10px;margin:6px 0;font-size:16px}
canvas{border:2px solid #2563eb;width:100%;touch-action:none}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #ccc;padding:6px;font-size:13px}
th{background:#e5e7eb}
#status{text-align:center;margin:6px}
</style>
</head>

<body>

<h2>üì¶ OCR Inventario ‚Äì Selecci√≥n Manual</h2>

<input type="file" accept="image/*" onchange="cargarImagen(event)">

<div id="status">Cargue una imagen</div>

<canvas id="canvas"></canvas>

<button onclick="procesarSeleccion()">üîç Leer √°rea seleccionada</button>
<button onclick="exportarExcel()">‚¨áÔ∏è Descargar Excel</button>

<table id="tabla">
<thead>
<tr>
<th>#</th><th>Texto OCR</th>
</tr>
</thead>
<tbody></tbody>
</table>

<script>
let canvas=document.getElementById("canvas");
let ctx=canvas.getContext("2d");
let img=new Image();
let startX,startY,endX,endY;
let seleccionando=false;
let contador=1;

function cargarImagen(e){
  const file=e.target.files[0];
  if(!file) return;

  img.onload=()=>{
    canvas.width=img.width;
    canvas.height=img.height;
    ctx.drawImage(img,0,0);
  };
  img.src=URL.createObjectURL(file);
}

canvas.addEventListener("pointerdown",e=>{
  startX=e.offsetX;
  startY=e.offsetY;
  seleccionando=true;
});

canvas.addEventListener("pointermove",e=>{
  if(!seleccionando) return;
  ctx.drawImage(img,0,0);
  ctx.strokeStyle="red";
  ctx.lineWidth=2;
  ctx.strokeRect(startX,startY,e.offsetX-startX,e.offsetY-startY);
});

canvas.addEventListener("pointerup",e=>{
  endX=e.offsetX;
  endY=e.offsetY;
  seleccionando=false;
});

async function procesarSeleccion(){
  if(startX==null||endX==null){
    alert("Seleccione un √°rea primero");
    return;
  }

  const w=Math.abs(endX-startX);
  const h=Math.abs(endY-startY);
  const x=Math.min(startX,endX);
  const y=Math.min(startY,endY);

  const temp=document.createElement("canvas");
  temp.width=w;
  temp.height=h;
  temp.getContext("2d").drawImage(canvas,x,y,w,h,0,0,w,h);

  status.innerText="OCR en √°rea seleccionada‚Ä¶";

  const {data:{text}}=await Tesseract.recognize(temp,'spa+eng');

  if(text.trim()) agregarFila(text.trim());
  status.innerText="Listo";
}

function agregarFila(texto){
  const tr=tabla.querySelector("tbody").insertRow();
  tr.insertCell(0).innerText=contador++;
  tr.insertCell(1).innerText=texto;
}

function exportarExcel(){
  const filas=[["#","Texto OCR"]];
  document.querySelectorAll("#tabla tbody tr").forEach(tr=>{
    filas.push([tr.cells[0].innerText,tr.cells[1].innerText]);
  });

  const hoja=XLSX.utils.aoa_to_sheet(filas);
  const libro=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(libro,hoja,"Datos");
  XLSX.writeFile(libro,"inventario_area.xlsx");
}
</script>

</body>
</html>
