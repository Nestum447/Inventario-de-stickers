<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>OCR Inventario PRO</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body{font-family:Arial;background:#f3f4f6;padding:14px}
h2{text-align:center}
button{width:100%;padding:12px;margin:6px 0;font-size:16px;border:none;border-radius:6px}
.primary{background:#2563eb;color:white}
.secondary{background:#16a34a;color:white}
.export{background:#111827;color:white}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #ccc;padding:6px;font-size:13px}
th{background:#e5e7eb}
#status{text-align:center;font-size:14px;margin:8px}

canvas{
  width:100%;
  border:2px dashed #999;
  margin-top:10px;
  touch-action:none;
}
</style>
</head>

<body>

<h2>üì¶ OCR Inventario PRO</h2>

<button class="primary" onclick="camara.click()">üì∑ Tomar foto</button>
<button class="secondary" onclick="galeria.click()">üñºÔ∏è Cargar imagen</button>

<input id="camara" type="file" accept="image/*" capture="environment" hidden onchange="cargarImagen(this)">
<input id="galeria" type="file" accept="image/*" hidden onchange="cargarImagen(this)">

<div id="status">Dibuja o mueve el cuadro</div>

<canvas id="canvas"></canvas>

<button class="export" onclick="procesarOCR()">üîç Extraer texto</button>
<button class="export" onclick="exportarExcel()">‚¨áÔ∏è Descargar Excel</button>

<table id="tabla">
<thead>
<tr>
<th>#</th>
<th>Descripci√≥n</th>
</tr>
</thead>
<tbody></tbody>
</table>

<script>
let canvas = document.getElementById("canvas");
let ctx = canvas.getContext("2d");
let img = new Image();

let startX=0, startY=0, endX=0, endY=0;
let drawing=false, moving=false;
let contador=1;

/* ======================
   CARGAR IMAGEN
====================== */
function cargarImagen(input){
  const file = input.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = e => {
    img.onload = () => {
      const max = 1200;
      const scale = Math.min(max/img.width, max/img.height, 1);

      canvas.width = img.width * scale;
      canvas.height = img.height * scale;

      draw();
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

/* ======================
   DIBUJAR
====================== */
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(img,0,0,canvas.width,canvas.height);

  if(endX){
    ctx.strokeStyle="red";
    ctx.lineWidth=2;
    ctx.strokeRect(
      startX,
      startY,
      endX-startX,
      endY-startY
    );
  }
}

/* ======================
   POSICI√ìN REAL DEL DEDO
====================== */
function getPos(e){
  const rect = canvas.getBoundingClientRect();
  const scaleX = canvas.width / rect.width;
  const scaleY = canvas.height / rect.height;

  return {
    x: (e.clientX - rect.left) * scaleX,
    y: (e.clientY - rect.top) * scaleY
  };
}

/* ======================
   INTERACCI√ìN
====================== */
canvas.addEventListener("pointerdown",e=>{
  const p = getPos(e);

  if(
    p.x > startX && p.x < endX &&
    p.y > startY && p.y < endY
  ){
    moving = true;
  }else{
    drawing = true;
    startX = p.x;
    startY = p.y;
    endX = p.x;
    endY = p.y;
  }
});

canvas.addEventListener("pointermove",e=>{
  if(!drawing && !moving) return;

  const p = getPos(e);

  if(drawing){
    endX = p.x;
    endY = p.y;
  }else if(moving){
    const w = endX - startX;
    const h = endY - startY;
    startX = p.x - w/2;
    startY = p.y - h/2;
    endX = startX + w;
    endY = startY + h;
  }

  draw();
});

canvas.addEventListener("pointerup",()=>{
  drawing = false;
  moving = false;
});

/* ======================
   OCR SOLO DEL √ÅREA
====================== */
async function procesarOCR(){
  if(!endX){
    alert("Selecciona un √°rea primero");
    return;
  }

  status.innerText = "OCR r√°pido‚Ä¶";

  const x = Math.min(startX,endX);
  const y = Math.min(startY,endY);
  const w = Math.abs(endX-startX);
  const h = Math.abs(endY-startY);

  const cut = document.createElement("canvas");
  cut.width = w;
  cut.height = h;
  cut.getContext("2d").drawImage(
    canvas,x,y,w,h,0,0,w,h
  );

  const {data:{text}} = await Tesseract.recognize(
    cut,
    "spa+eng",
    { tessedit_pageseg_mode: Tesseract.PSM.SINGLE_LINE }
  );

  const limpio = text.replace(/\s+/g," ").trim();
  if(limpio) agregarFila(limpio);

  status.innerText="‚úÖ Texto extra√≠do";
}

/* ======================
   TABLA / EXCEL
====================== */
function agregarFila(t){
  const tr = tabla.querySelector("tbody").insertRow();
  tr.insertCell(0).innerText = contador++;
  tr.insertCell(1).innerText = t;
}

function exportarExcel(){
  const filas = [["#","Descripci√≥n"]];
  document.querySelectorAll("#tabla tbody tr").forEach(tr=>{
    filas.push([...tr.cells].map(td=>td.innerText));
  });

  const hoja = XLSX.utils.aoa_to_sheet(filas);
  const libro = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(libro,hoja,"Inventario");
  XLSX.writeFile(libro,"inventario_pro.xlsx");
}
</script>

</body>
</html>
