<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>OCR Inventario PRO</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body{font-family:Arial;background:#f3f4f6;padding:14px}
h2{text-align:center}

button{
  width:100%;
  padding:12px;
  margin:6px 0;
  font-size:16px;
  border:none;
  border-radius:6px
}

.primary{background:#2563eb;color:white}
.secondary{background:#16a34a;color:white}
.export{background:#111827;color:white}

button.loading{background:#9ca3af!important;cursor:not-allowed}

#status{text-align:center;font-size:14px;margin:8px}

#progressBox{
  width:100%;
  background:#e5e7eb;
  border-radius:6px;
  overflow:hidden;
  display:none;
  margin-top:8px
}

#progressBar{width:0%;height:12px;background:#2563eb}
#progressText{text-align:center;font-size:13px;font-weight:bold}

table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #ccc;padding:6px;font-size:13px}
th{background:#e5e7eb}

td.editing{outline:2px solid #2563eb;background:#eef2ff}

.btn-del{
  background:#dc2626;
  color:white;
  border:none;
  border-radius:4px;
  padding:4px 6px;
  cursor:pointer
}

canvas{
  width:100%;
  border:2px dashed #999;
  margin-top:10px;
  touch-action:none
}
</style>
</head>

<body>

<h2>üì¶ OCR Inventario PRO</h2>

<button class="primary" onclick="camara.click()">üì∑ Tomar foto</button>
<button class="secondary" onclick="galeria.click()">üñºÔ∏è Cargar imagen</button>

<input id="camara" type="file" accept="image/*" capture="environment" hidden onchange="cargarImagen(this)">
<input id="galeria" type="file" accept="image/*" hidden onchange="cargarImagen(this)">

<div id="status">Dibuja o arrastra el cuadro</div>

<canvas id="canvas"></canvas>

<button id="btnOCR" class="export" onclick="procesarOCR()">üîç Extraer texto</button>
<button class="export" onclick="exportarExcel()">‚¨áÔ∏è Descargar Excel</button>

<div id="progressBox"><div id="progressBar"></div></div>
<div id="progressText"></div>

<table id="tabla">
<thead>
<tr>
<th>#</th>
<th>Descripci√≥n</th>
<th>‚ùå</th>
</tr>
</thead>
<tbody></tbody>
</table>

<script>
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");
const img=new Image();

let x1=0,y1=0,x2=0,y2=0;
let mode=null;
let offsetX=0,offsetY=0;
let contador=1;

const STORAGE_KEY="inventario_ocr_registros";

/* ============ PERSISTENCIA ============ */
function guardarTabla(){
  const data=[];
  document.querySelectorAll("#tabla tbody tr").forEach(tr=>{
    data.push(tr.cells[1].innerText);
  });
  localStorage.setItem(STORAGE_KEY,JSON.stringify(data));
}

function cargarTabla(){
  const data=JSON.parse(localStorage.getItem(STORAGE_KEY)||"[]");
  data.forEach(txt=>agregarFila(txt,false));
}

window.addEventListener("load",cargarTabla);

/* ================= CARGAR IMAGEN ================= */
function cargarImagen(input){
  const file=input.files[0];
  if(!file) return;

  const reader=new FileReader();
  reader.onload=e=>{
    img.onload=()=>{
      const scale=Math.min(1200/img.width,1);
      canvas.width=img.width*scale;
      canvas.height=img.height*scale;
      x1=y1=x2=y2=0;
      draw();
    };
    img.src=e.target.result;
  };
  reader.readAsDataURL(file);
}

/* ================= DIBUJO ================= */
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(img,0,0,canvas.width,canvas.height);
  if(x2){
    ctx.strokeStyle="red";
    ctx.lineWidth=2;
    ctx.strokeRect(x1,y1,x2-x1,y2-y1);
  }
}

function getPos(e){
  const r=canvas.getBoundingClientRect();
  return {
    x:(e.clientX-r.left)*(canvas.width/r.width),
    y:(e.clientY-r.top)*(canvas.height/r.height)
  };
}

/* ================= INTERACCI√ìN ================= */
canvas.addEventListener("pointerdown",e=>{
  const p=getPos(e);

  if(p.x>x1 && p.x<x2 && p.y>y1 && p.y<y2){
    mode="move";
    offsetX=p.x-x1;
    offsetY=p.y-y1;
  }else{
    mode="draw";
    x1=p.x; y1=p.y;
    x2=p.x; y2=p.y;
  }
});

canvas.addEventListener("pointermove",e=>{
  if(!mode) return;
  const p=getPos(e);

  if(mode==="draw"){
    x2=p.x; y2=p.y;
  }

  if(mode==="move"){
    const w=x2-x1, h=y2-y1;
    x1=p.x-offsetX;
    y1=p.y-offsetY;
    x2=x1+w;
    y2=y1+h;
  }

  draw();
});

canvas.addEventListener("pointerup",()=>mode=null);

/* ================= OCR ================= */
async function procesarOCR(){
  if(!x2) return alert("Selecciona un √°rea");

  btnOCR.disabled=true;
  btnOCR.classList.add("loading");

  progressBox.style.display="block";
  progressBar.style.width="0%";
  progressText.innerText="0%";

  const x=Math.min(x1,x2), y=Math.min(y1,y2);
  const w=Math.abs(x2-x1), h=Math.abs(y2-y1);

  const cut=document.createElement("canvas");
  cut.width=w; cut.height=h;
  cut.getContext("2d").drawImage(canvas,x,y,w,h,0,0,w,h);

  const {data:{text}}=await Tesseract.recognize(
    cut,"spa+eng",
    {logger:m=>{
      if(m.status==="recognizing text"){
        const p=Math.round(m.progress*100);
        progressBar.style.width=p+"%";
        progressText.innerText=p+"%";
      }
    }}
  );

  if(text.trim()) agregarFila(text.trim(),true);

  btnOCR.disabled=false;
  btnOCR.classList.remove("loading");
}

/* ================= TABLA ================= */
function agregarFila(texto,guardar=true){
  const tr=tabla.querySelector("tbody").insertRow();
  tr.insertCell(0).innerText=contador++;
  tr.insertCell(1).innerText=texto;

  const td=tr.insertCell(2);
  const b=document.createElement("button");
  b.innerText="üóë";
  b.className="btn-del";
  b.onclick=()=>{
    if(confirm("¬øEliminar esta fila?")){
      tr.remove();
      renumerar();
      guardarTabla();
    }
  };
  td.appendChild(b);

  if(guardar) guardarTabla();
}

function renumerar(){
  contador=1;
  document.querySelectorAll("#tabla tbody tr")
    .forEach(tr=>tr.cells[0].innerText=contador++);
}

/* EDICI√ìN DOBLE CLICK */
tabla.addEventListener("dblclick",e=>{
  const td=e.target;
  if(td.tagName!=="TD"||td.cellIndex!==1) return;

  const txt=td.innerText;
  td.innerHTML=`<input value="${txt}" style="width:100%">`;
  const input=td.firstChild;
  input.focus();

  input.onblur=()=>{
    td.innerText=input.value||txt;
    guardarTabla();
  };
  input.onkeydown=e=>{
    if(e.key==="Enter") input.blur();
    if(e.key==="Escape") td.innerText=txt;
  };
});

/* ================= EXCEL ================= */
function exportarExcel(){
  const data=[["#","Descripci√≥n"]];
  document.querySelectorAll("#tabla tbody tr").forEach(tr=>{
    data.push([tr.cells[0].innerText,tr.cells[1].innerText]);
  });
  const ws=XLSX.utils.aoa_to_sheet(data);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Inventario");
  XLSX.writeFile(wb,"inventario_pro.xlsx");
}
</script>

</body>
</html>
