<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>OCR Inventario PRO</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body{font-family:Arial;background:#f3f4f6;padding:14px}
h2{text-align:center}

button{
  width:100%;
  padding:12px;
  margin:6px 0;
  font-size:16px;
  border:none;
  border-radius:6px
}

.primary{background:#2563eb;color:white}
.secondary{background:#16a34a;color:white}
.export{background:#111827;color:white}

#status{text-align:center;font-size:14px;margin:8px}

/* CONTENEDOR */
#canvasContainer{
  width:100%;
  max-height:420px;
  border:2px dashed #999;
  overflow:auto;
  background:#fff;
  margin-top:10px;
}

/* SCROLL GRUESO */
#canvasContainer::-webkit-scrollbar{
  width:16px;
  height:16px;
}
#canvasContainer::-webkit-scrollbar-thumb{
  background:#9ca3af;
  border-radius:10px;
}
#canvasContainer::-webkit-scrollbar-track{
  background:#e5e7eb;
}

canvas{
  display:block;
  touch-action:none;
  transform-origin:0 0;
}

/* PROGRESO */
#progressBox{
  width:100%;
  background:#e5e7eb;
  border-radius:6px;
  overflow:hidden;
  display:none;
  margin-top:8px;
}
#progressBar{
  width:0%;
  height:12px;
  background:#2563eb;
}
#progressText{text-align:center;font-weight:bold}

table{
  width:100%;
  border-collapse:collapse;
  margin-top:10px
}
th,td{border:1px solid #ccc;padding:6px;font-size:13px}
th{background:#e5e7eb}
</style>
</head>

<body>

<h2>üì¶ OCR Inventario PRO</h2>

<button class="primary" onclick="camara.click()">üì∑ Tomar foto</button>
<button class="secondary" onclick="galeria.click()">üñºÔ∏è Cargar imagen</button>

<input id="camara" type="file" accept="image/*" capture="environment" hidden onchange="cargarImagen(this)">
<input id="galeria" type="file" accept="image/*" hidden onchange="cargarImagen(this)">

<div id="status">Selecciona un √°rea dentro de la imagen</div>

<div id="canvasContainer">
  <canvas id="canvas"></canvas>
</div>

<button class="export" onclick="procesarOCR()">üîç Extraer texto</button>

<div id="progressBox"><div id="progressBar"></div></div>
<div id="progressText"></div>

<table id="tabla">
<thead><tr><th>#</th><th>Descripci√≥n</th></tr></thead>
<tbody></tbody>
</table>

<script>
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");
const container=document.getElementById("canvasContainer");
let img=new Image();

let scale=1;
const MIN_ZOOM=0.5, MAX_ZOOM=3;

let x1=0,y1=0,x2=0,y2=0;
let mode=null;
let contador=1;
const HANDLE=12;

/* ======================
   CARGAR IMAGEN
====================== */
function cargarImagen(input){
  const file=input.files[0];
  if(!file) return;

  const reader=new FileReader();
  reader.onload=e=>{
    img.onload=()=>{
      canvas.width=img.width;
      canvas.height=img.height;
      scale=Math.min(container.clientWidth/img.width,1);
      x1=y1=x2=y2=0;
      draw();
    };
    img.src=e.target.result;
  };
  reader.readAsDataURL(file);
}

/* ======================
   DIBUJO
====================== */
function draw(){
  ctx.setTransform(scale,0,0,scale,0,0);
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(img,0,0);

  if(x2){
    ctx.strokeStyle="red";
    ctx.lineWidth=2/scale;
    ctx.strokeRect(x1,y1,x2-x1,y2-y1);
    drawHandles();
  }
}

function drawHandles(){
  ctx.fillStyle="red";
  [[x1,y1],[x2,y1],[x1,y2],[x2,y2]].forEach(p=>{
    ctx.beginPath();
    ctx.arc(p[0],p[1],(HANDLE/2)/scale,0,Math.PI*2);
    ctx.fill();
  });
}

/* ======================
   COORDENADAS
====================== */
function getPos(e){
  const r=canvas.getBoundingClientRect();
  return{
    x:(e.clientX-r.left)/scale,
    y:(e.clientY-r.top)/scale
  };
}

function dentroImagen(p){
  return p.x>=0 && p.y>=0 && p.x<=img.width && p.y<=img.height;
}

/* ======================
   INTERACCI√ìN
====================== */
canvas.addEventListener("pointerdown",e=>{
  const p=getPos(e);
  if(!dentroImagen(p)) return;

  mode="draw";
  x1=p.x; y1=p.y;
  x2=p.x; y2=p.y;
});

canvas.addEventListener("pointermove",e=>{
  if(!mode) return;
  const p=getPos(e);
  if(!dentroImagen(p)) return;
  x2=p.x; y2=p.y;
  draw();
});

canvas.addEventListener("pointerup",()=>mode=null);

/* ======================
   ZOOM DESDE CONTENEDOR
====================== */
container.addEventListener("wheel",e=>{
  e.preventDefault();
  const delta=e.deltaY<0?1.1:0.9;
  scale=Math.min(Math.max(scale*delta,MIN_ZOOM),MAX_ZOOM);
  draw();
},{passive:false});

/* ======================
   OCR CORREGIDO
====================== */
async function procesarOCR(){
  if(!x2) return alert("Selecciona un √°rea v√°lida");

  const x=Math.min(x1,x2);
  const y=Math.min(y1,y2);
  const w=Math.abs(x2-x1);
  const h=Math.abs(y2-y1);

  const cut=document.createElement("canvas");
  cut.width=w;
  cut.height=h;
  cut.getContext("2d").drawImage(img,x,y,w,h,0,0,w,h);

  progressBox.style.display="block";

  const {data:{text}}=await Tesseract.recognize(
    cut,"spa+eng",{logger:m=>{
      if(m.status==="recognizing text"){
        progressBar.style.width=(m.progress*100)+"%";
        progressText.innerText=Math.round(m.progress*100)+"%";
      }
    }}
  );

  const limpio=text.replace(/\s+/g," ").trim();
  if(limpio){
    const tr=tabla.querySelector("tbody").insertRow();
    tr.insertCell(0).innerText=contador++;
    tr.insertCell(1).innerText=limpio;
  }
}
</script>

</body>
</html>
